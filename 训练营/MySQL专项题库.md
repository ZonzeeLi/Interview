# MySQL 专项题库

## 架构

### 说一说执行一条查询 SQL 语句的全过程

首先是通过连接器，建立与 MySQL 的连接，如果语句是 Select 查询语句，会查询缓存，命中直接返回，其他情况，解析器会对 SQL 语句进行解析，如果语法不对则报错，语法正确则交由执行器真正开始执行 SQL 语句，执行器中有三个阶段，分别是预处理阶段、优化阶段、执行阶段，预处理阶段就是看表是否存在和`*`号改为查所有列，优化阶段就是看使用哪个索引，执行阶段就是去存储引擎中查询到记录然后返回。

## 存储引擎

### MySQL 存储引擎有哪些？各自有什么区别？

主要有 MyISAM、InnoDB两个比较热门讨论的存储引擎，InnoDB是现在默认的存储引擎。

### MyISAM 和 InnoDB 存储引擎有什么区别？

主要区别有：

- 数据存放的文件规则和格式不同；
- MyISAM不支持事务而InnoDB支持；
- MyISAM的索引只有非聚簇索引；
- MyISAM不支持行锁只有表锁性能不如InnoDB；
- MyISAM只有binlog，所以如果没写入binlog的操作会数据丢失，InnoDB有redolog，可以在事务提交后出现故障，进行数据恢复，因为redologbuffer是语句执行前开始写入的，然后在事务提交后刷盘。

### 用 count(*) 哪个存储引擎会更快？

用 MyISAM 更快，因为 MyISAM 会事先对行记录统计记录。

## 索引结构

### MySQL 有哪些索引类型？

B树索引、哈希索引、fulltext索引

### InnodB 引擎的索引数据结构是什么？

B+树

### 为什么索引用 B+ 树？而不用红黑树？

红黑树的实现复杂，且在数据量大的时候层级过多，而 B+ 树的层级稳定维持在3～4层左右，这样就会导致在查询的时候 I/O 次数过多，而红黑树的自平衡能力会导致在表结构发生变化时有较大的改变。

### 为什么索引用 B+ 树？而不用 B 树？

B+的非叶子节点只存放索引，而B树会存放索引和数据，所以B+树会存放更多的索引，层级更少，查询更快。B+树的叶子节点是用双向链表连接，可以很快的范围查询，而B树只能回到根节点再向下查找，所以I/O次数多。

### B 树适合什么应用场景？

这个并不了解。

### 为什么索引用 B+ 树？而不用哈希表？

哈希虽然查询某一值时有O（1）的时间复杂度，但是没有办法做到范围查询。

### 聚簇索引和非聚簇索引有什么区别？

聚簇索引具有唯一性，主键可以作为聚簇索引，如果没有主键会选择一个不包含NULL的唯一列，如果也没有，会生成一个自增id作为聚簇索引。

非聚簇索引只存放聚簇索引，而聚簇索引存放的完整的记录信息。

### insert  操作对 B+ 树结构的改变是怎么样的？

B+树会通过二分查找的方法找到插入的位置，如果可以直接插入则构建叶子节点插入，也要和前后叶子节点构建成双向链表，如果超过某一个非叶子节点的最大数量，则会让非叶子节点分类，重新构建依此向上级进行。

### 假如一张表有两千万的数据，B+树的高度是多少？怎么算的？

这个并不了解。

## 索引应用

### MySQL 有哪些索引？

按照索引类型，可以分为B树索引、哈希索引、fulltext索引。

按照使用的存储方式，可以分为聚簇索引和非聚簇索引，聚簇索引的叶子节点存放所有的数据记录，而非聚簇索引的叶子节点只存放聚簇索引。

按照使用的列的个数，可以分为单列索引和联合索引。

按照使用的字段，可以分为主键索引、唯一索引、前缀索引和普通索引。

### 为什么要建索引？

索引好比是书的目录，可以快速查找定位信息，加快查询速度。

### 我们一般选择什么样的字段来建立索引？

首先是主键字段要作为聚簇索引，用来保存完整记录信息，而其他的需要进行等值查询和排序查询的字段，比较适合建立索引，因为等值查询可以快速定位查找信息，排序的字段，索引会在构建B+树的时候以排序的方式构建，之后可以用索引下推避免回表次数过多浪费时间。

### 索引越多越好吗？

并不是，一个索引就要构建一个B+树，所以过多的索引会导致磁盘文件过多，而且一条语句中如果涉及到多个索引，在修改时会对每一个索引的B+树进行结构修改，会导致I/O次数过多。

### 索引怎么优化？

1. 使用覆盖索引，可以利用将需要查询的多个值建立成联合索引，避免再次向上回表。
2. 如果字段过长，可以使用前缀索引来优化长度。
3. 防止索引失效，语句的一些不正确使用会导致索引失效。
4. 不要创建太多的索引，只为常用的字段构建索引，防止浪费过多的存储空间。
5. 主键索引要设置为自增，自增会让一条新纪录在插入时更加方便，否则会让B+树有重新构建的可能。
6. 如果是范围查询或者排序的字段，可以建立索引使用索引下推来优化I/O次数

### 建立了索引，查询的时候一定会用到索引吗？

不一定，存在索引失效的可能，索引失效的情况有：

1. 联合索引不满足最左匹配原则，比如（A，B，C）构建的联合索引，要按照A、B、C的优先级顺序使用索引。
2. 索引如果使用了函数计算则会失效。
3. 索引如果使用了表达式计算则会失效。
4. 索引如果使用了类型转换则会失效。
5. 索引如果遇到>，<，between这种范围查询会停止。
6. 使用where语句的or关键字，如果or的左右两边不全是索引列的话会失效。
7. 如果使用了模糊查询的左模糊匹配，会导致索引失效，因为不满足排序性。

### 什么是最左匹配原则？

联合索引的最左优先级最高，使用索引的时候会优先从左侧开始匹配，比如（A，B，C），要优先使用A进行匹配，然后再用B，再用C，如果不是按照这个顺序则索引失效。

### 联合索引 （a,b,c），下面的查询语句会不会走索引？如果走具体是哪些字段能走？

1. select * from T where a=1 and b=2 and c=3;

会走索引，a、b、c均可以走索引。

2. select * from T where a=1 and b>2 and c=3;

会走索引，a、b、c均可以走索引。
